name: build
run-name: 'build â†’ ${{ github.event.inputs.branch || github.event.workflow_run.head_branch || github.ref_name }}'

on:
  workflow_run:
    workflows: ['typecheck']
    branches: [main]
    types: [completed]

  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build'
        required: true
        default: 'main'

permissions:
  contents: write
  actions: write

jobs:
  build:
    name: Build ${{ matrix.artifact_ext }} (${{ matrix.platform }}) on ${{ github.event.inputs.branch || github.event.workflow_run.head_branch || github.ref_name }}
    if: ${{ (github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')) && github.actor != 'github-actions' }}
    runs-on: ${{ matrix.os }}
    env:
      BUILD_BRANCH: ${{ github.event.inputs.branch || github.event.workflow_run.head_branch || github.head_ref || github.ref_name }}
      HUSKY: 0
      ELECTRON_CACHE: .cache/electron
      ELECTRON_BUILDER_CACHE: .cache/electron-builder

    strategy:
      matrix:
        include:
          - platform: x86_64
            os: ubuntu-latest
            arch: native
            artifact_ext: AppImage
          - platform: arm64
            os: ubuntu-latest
            arch: emulated
            artifact_ext: AppImage
          - platform: darwin
            os: macos-latest
            arch: native
            artifact_ext: dmg

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.branch && format('refs/heads/{0}', github.event.inputs.branch) || format('refs/heads/{0}', github.event.workflow_run.head_branch) }}

      # ----------------------------
      # Caches
      # ----------------------------
      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: .pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ matrix.platform }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-${{ matrix.platform }}-

      - name: Cache build caches (vite/esbuild)
        uses: actions/cache@v4
        with:
          path: |
            node_modules/.vite
            node_modules/.cache
          key: build-cache-${{ runner.os }}-${{ matrix.platform }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            build-cache-${{ runner.os }}-${{ matrix.platform }}-

      - name: Cache Electron downloads
        uses: actions/cache@v4
        with:
          path: .cache/electron
          key: electron-cache-${{ runner.os }}-${{ matrix.platform }}-${{ hashFiles('package.json', 'pnpm-lock.yaml') }}
          restore-keys: |
            electron-cache-${{ runner.os }}-${{ matrix.platform }}-

      - name: Cache electron-builder binaries
        uses: actions/cache@v4
        with:
          path: .cache/electron-builder
          key: eb-cache-${{ runner.os }}-${{ matrix.platform }}-${{ hashFiles('package.json', 'pnpm-lock.yaml', 'electron-builder.yml') }}
          restore-keys: |
            eb-cache-${{ runner.os }}-${{ matrix.platform }}-

      - name: Setup Node + pnpm
        id: pnpm
        uses: ./.github/actions/pnpm
        with:
          node-version: '24'
          pnpm-major: '10'
          pnpm-store-dir: '.pnpm-store'

      - name: Read version from package.json
        id: pkg
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Read Electron semver from package.json
        id: el
        run: |
          echo "semver=$(node -p 'require(\"./package.json\").devDependencies.electron')" >> "$GITHUB_OUTPUT"

      # ----------------------------
      # Linux x86_64
      # ----------------------------
      - name: Install Linux deps [x86_64]
        if: matrix.platform == 'x86_64'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
              build-essential python3 python3-dev libusb-1.0-0-dev libudev-dev \
              pkg-config libusb-1.0-0 libudev1 ca-certificates
          sudo rm -rf /var/lib/apt/lists/*

      - name: Install deps (pnpm) [x86_64]
        if: matrix.platform == 'x86_64'
        run: pnpm install --frozen-lockfile

      - name: Build for x86_64 (native Ubuntu)
        if: matrix.platform == 'x86_64'
        shell: bash
        run: |
          set -euo pipefail
          ELECTRON_VERSION=$(node -p "require('./node_modules/electron/package.json').version")
          npx --yes node-gyp install --target="$ELECTRON_VERSION" --dist-url=https://artifacts.electronjs.org/headers/dist
          pnpm run rebuild:native
          pnpm run typecheck
          rm -rf dist
          pnpm run build:linux

      # ----------------------------
      # Linux arm64 (emulated via Docker + QEMU)
      # ----------------------------
      - name: Enable binfmt for ARM64 containers [arm64]
        if: matrix.platform == 'arm64'
        shell: bash
        run: |
          set -euo pipefail
          docker run --privileged --rm tonistiigi/binfmt --install arm64 >/dev/null

      - name: Build for ARM64 (emulated)
        if: matrix.platform == 'arm64'
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p .pnpm-store .cache/electron .cache/electron-builder
          chmod -R a+rwx .pnpm-store .cache || true

          docker run --rm --platform=linux/arm64/v8 \
            -v "${GITHUB_WORKSPACE}:/work" \
            -w /work \
            -e HUSKY=0 \
            -e PNPM_NODE_LINKER=hoisted \
            -e PNPM_SHAMEFULLY_HOIST=true \
            -e ELECTRON_CACHE=/work/.cache/electron \
            -e ELECTRON_BUILDER_CACHE=/work/.cache/electron-builder \
            node:24-trixie-slim bash -lc '
              set -euo pipefail

              apt-get update
              apt-get install -y --no-install-recommends \
                git build-essential python3 python3-dev \
                libusb-1.0-0-dev libudev-dev pkg-config \
                libusb-1.0-0 libudev1 ca-certificates \
                liblzo2-2
              rm -rf /var/lib/apt/lists/*

              corepack enable
              corepack install
              pnpm --version

              pnpm config set store-dir /work/.pnpm-store
              pnpm install --frozen-lockfile

              ELECTRON_VERSION="$(node -p "require(\"./node_modules/electron/package.json\").version")"
              npx --yes node-gyp install --target="$ELECTRON_VERSION" --dist-url=https://artifacts.electronjs.org/headers/dist

              pnpm run rebuild:native
              pnpm run build:armLinux
            '

      - name: Fix cache permissions after ARM64 container
        if: matrix.platform == 'arm64'
        shell: bash
        run: |
          set -euo pipefail
          # docker wrote these as root -> actions/cache runs as runner user -> tar can't read
          sudo chown -R "$USER:$USER" .cache .pnpm-store node_modules/.vite node_modules/.cache 2>/dev/null || true
          sudo chmod -R a+rX .cache .pnpm-store node_modules/.vite node_modules/.cache 2>/dev/null || true

      # ----------------------------
      # macOS
      # ----------------------------
      - name: Install deps (brew) [darwin]
        if: matrix.platform == 'darwin'
        shell: bash
        run: |
          set -euo pipefail
          brew update >/dev/null
          for pkg in libusb pkg-config; do
            if ! brew list --versions "$pkg" >/dev/null; then
              brew install "$pkg" >/dev/null
            elif brew outdated --quiet | grep -q "^$pkg\$"; then
              brew upgrade "$pkg" >/dev/null
            fi
          done

      - name: Install deps (pnpm) [darwin]
        if: matrix.platform == 'darwin'
        shell: bash
        run: pnpm install --frozen-lockfile

      - name: Build for macOS (native)
        if: matrix.platform == 'darwin'
        shell: bash
        run: |
          set -euo pipefail
          ELECTRON_VERSION=$(node -p "require('./node_modules/electron/package.json').version")
          npx --yes node-gyp install --target="$ELECTRON_VERSION" --dist-url=https://artifacts.electronjs.org/headers/dist
          pnpm run rebuild:native
          pnpm run typecheck
          pnpm run build:mac

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: LIVI-${{ steps.pkg.outputs.version }}-${{ matrix.platform }}.${{ matrix.artifact_ext }}
          path: |
            dist/*${{ matrix.artifact_ext == 'dmg' && 'arm64.dmg' || (matrix.artifact_ext == 'AppImage' && (matrix.platform == 'arm64' && '-arm64.AppImage' || '-x86_64.AppImage')) }}
          retention-days: 7

      - name: Push badges to version branch
        if: matrix.platform == 'x86_64' && (env.BUILD_BRANCH == 'main' || env.BUILD_BRANCH == 'dev')
        uses: ./.github/actions/badges
        with:
          branch: ${{ env.BUILD_BRANCH }}
          version: ${{ steps.pkg.outputs.version }}
          node: ${{ steps.pnpm.outputs.node }}
          pnpm: ${{ steps.pnpm.outputs.pnpm }}
          repo: ${{ github.repository }}
          token: ${{ secrets.GITHUB_TOKEN }}
