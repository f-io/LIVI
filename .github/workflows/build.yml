name: build
run-name: 'build â†’ ${{ github.event.inputs.branch || github.event.workflow_run.head_branch || github.ref_name }}'

on:
  workflow_run:
    workflows: ['typecheck']
    branches: [main]
    types: [completed]

  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build'
        required: true
        default: 'main'
      linux_x86_64:
        description: 'Build Linux x86_64 (AppImage)'
        type: boolean
        default: false
      linux_arm64:
        description: 'Build Linux arm64 (AppImage, emulated)'
        type: boolean
        default: false
      macos_arm64:
        description: 'Build macOS arm64 (dmg)'
        type: boolean
        default: false
      windows_x64:
        description: 'Build Windows x64 (nsis)'
        type: boolean
        default: false

permissions:
  contents: write
  actions: write

jobs:
  # ------------------------------------------------------------
  # Manual builds (matrix), only for selected targets
  # ------------------------------------------------------------
  build:
    name: Build ${{ matrix.artifact_ext }} (${{ matrix.platform }}) on ${{ github.event.inputs.branch }}
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
    runs-on: ${{ matrix.os }}
    env:
      BUILD_BRANCH: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.branch || github.event.workflow_run.head_branch }}
      HUSKY: 0
      ELECTRON_CACHE: .cache/electron
      ELECTRON_BUILDER_CACHE: .cache/electron-builder

    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: x86_64
            os: ubuntu-latest
            arch: native
            artifact_ext: AppImage
            enabled: ${{ github.event_name == 'workflow_run' || github.event.inputs.linux_x86_64 == 'true' }}

          - platform: arm64
            os: ubuntu-latest
            arch: emulated
            artifact_ext: AppImage
            enabled: ${{ github.event_name == 'workflow_run' || github.event.inputs.linux_arm64 == 'true' }}

          - platform: darwin
            os: macos-latest
            arch: native
            artifact_ext: dmg
            enabled: ${{ github.event_name == 'workflow_run' || github.event.inputs.macos_arm64 == 'true' }}

          - platform: win-x64
            os: windows-latest
            arch: native
            artifact_ext: exe
            enabled: ${{ github.event_name == 'workflow_run' || github.event.inputs.windows_x64 == 'true' }}

    steps:
      - name: Skip if not selected
        if: ${{ !matrix.enabled }}
        run: |
          echo "Not selected in workflow_dispatch inputs -> skipping."
          exit 0

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && format('refs/heads/{0}', github.event.inputs.branch) || github.event.workflow_run.head_sha }}

      # ----------------------------
      # Caches
      # ----------------------------
      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: .pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ matrix.platform }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-${{ matrix.platform }}-

      - name: Cache build caches (vite/esbuild)
        if: ${{ matrix.platform != 'win-x64' }}
        uses: actions/cache@v4
        with:
          path: |
            node_modules/.vite
            node_modules/.cache
          key: build-cache-${{ runner.os }}-${{ matrix.platform }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            build-cache-${{ runner.os }}-${{ matrix.platform }}-

      - name: Cache Electron downloads
        uses: actions/cache@v4
        with:
          path: .cache/electron
          key: electron-cache-${{ runner.os }}-${{ matrix.platform }}-${{ hashFiles('package.json', 'pnpm-lock.yaml') }}
          restore-keys: |
            electron-cache-${{ runner.os }}-${{ matrix.platform }}-

      - name: Cache electron-builder binaries
        uses: actions/cache@v4
        with:
          path: .cache/electron-builder
          key: eb-cache-${{ runner.os }}-${{ matrix.platform }}-${{ hashFiles('package.json', 'pnpm-lock.yaml', 'electron-builder.yml') }}
          restore-keys: |
            eb-cache-${{ runner.os }}-${{ matrix.platform }}-

      - name: Setup Node + pnpm
        id: pnpm
        uses: ./.github/actions/pnpm
        with:
          node-version: '24'
          pnpm-major: '10'
          pnpm-store-dir: '.pnpm-store'

      - name: Read version from package.json
        id: pkg
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Read Electron semver from package.json
        id: el
        shell: bash
        run: |
          echo "semver=$(node -p 'require(\"./package.json\").devDependencies.electron')" >> "$GITHUB_OUTPUT"

      # ----------------------------
      # Linux x86_64
      # ----------------------------
      - name: Install Linux deps [x86_64]
        if: matrix.platform == 'x86_64'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
              build-essential python3 python3-dev libusb-1.0-0-dev libudev-dev \
              pkg-config libusb-1.0-0 libudev1 ca-certificates
          sudo rm -rf /var/lib/apt/lists/*

      - name: Install deps (pnpm) [x86_64]
        if: matrix.platform == 'x86_64'
        run: pnpm install --frozen-lockfile

      - name: Build for x86_64 (native Ubuntu)
        if: matrix.platform == 'x86_64'
        shell: bash
        run: |
          set -euo pipefail
          ELECTRON_VERSION=$(node -p "require('./node_modules/electron/package.json').version")
          npx --yes node-gyp install --target="$ELECTRON_VERSION" --dist-url=https://artifacts.electronjs.org/headers/dist
          pnpm run typecheck
          rm -rf dist
          pnpm run build:linux

      # ----------------------------
      # Linux arm64 (emulated via Docker + QEMU)
      # ----------------------------
      - name: Enable binfmt for ARM64 containers [arm64]
        if: matrix.platform == 'arm64'
        shell: bash
        run: |
          set -euo pipefail
          docker run --privileged --rm tonistiigi/binfmt --install arm64 >/dev/null

      - name: Build for ARM64 (emulated)
        if: matrix.platform == 'arm64'
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p .pnpm-store .cache/electron .cache/electron-builder
          chmod -R a+rwx .pnpm-store .cache || true

          docker run --rm --platform=linux/arm64/v8 \
            -v "${GITHUB_WORKSPACE}:/work" \
            -w /work \
            -e HUSKY=0 \
            -e PNPM_NODE_LINKER=hoisted \
            -e PNPM_SHAMEFULLY_HOIST=true \
            -e ELECTRON_CACHE=/work/.cache/electron \
            -e ELECTRON_BUILDER_CACHE=/work/.cache/electron-builder \
            node:24-trixie-slim bash -lc '
              set -euo pipefail

              apt-get update
              apt-get install -y --no-install-recommends \
                git build-essential python3 python3-dev \
                libusb-1.0-0-dev libudev-dev pkg-config \
                libusb-1.0-0 libudev1 ca-certificates \
                liblzo2-2
              rm -rf /var/lib/apt/lists/*

              corepack enable
              corepack install
              pnpm --version

              pnpm config set store-dir /work/.pnpm-store
              pnpm install --frozen-lockfile

              ELECTRON_VERSION="$(node -p "require(\"./node_modules/electron/package.json\").version")"
              npx --yes node-gyp install --target="$ELECTRON_VERSION" --dist-url=https://artifacts.electronjs.org/headers/dist

              pnpm run build:armLinux
            '

      - name: Fix cache permissions after ARM64 container
        if: matrix.platform == 'arm64'
        shell: bash
        run: |
          set -euo pipefail
          sudo chown -R "$USER:$USER" .cache .pnpm-store node_modules/.vite node_modules/.cache 2>/dev/null || true
          sudo chmod -R a+rX .cache .pnpm-store node_modules/.vite node_modules/.cache 2>/dev/null || true

      # ----------------------------
      # macOS
      # ----------------------------
      - name: Install deps (brew) [darwin]
        if: matrix.platform == 'darwin'
        shell: bash
        run: |
          set -euo pipefail
          brew update >/dev/null
          for pkg in libusb pkg-config; do
            if ! brew list --versions "$pkg" >/dev/null; then
              brew install "$pkg" >/dev/null
            elif brew outdated --quiet | grep -q "^$pkg\$"; then
              brew upgrade "$pkg" >/dev/null
            fi
          done

      - name: Install deps (pnpm) [darwin]
        if: matrix.platform == 'darwin'
        shell: bash
        run: pnpm install --frozen-lockfile

      - name: Build for macOS (native)
        if: matrix.platform == 'darwin'
        shell: bash
        run: |
          set -euo pipefail
          ELECTRON_VERSION=$(node -p "require('./node_modules/electron/package.json').version")
          npx --yes node-gyp install --target="$ELECTRON_VERSION" --dist-url=https://artifacts.electronjs.org/headers/dist
          pnpm run typecheck
          pnpm run build:mac

      # ----------------------------
      # Windows
      # ----------------------------
      - name: Install deps (pnpm) [win-x64]
        if: matrix.platform == 'win-x64'
        shell: pwsh
        run: pnpm install --frozen-lockfile

      - name: Fetch ffplay bundle (f-io/ffmpeg-bundles latest) [win-x64]
        if: matrix.platform == 'win-x64'
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $ErrorActionPreference = "Stop"

          New-Item -ItemType Directory -Force -Path "assets/bin/win" | Out-Null

          $assetName = "ffplay-win-x64.zip"
          $zip = Join-Path $env:RUNNER_TEMP $assetName

          $tag = (gh release view --repo f-io/ffmpeg-bundles latest --json tagName -q ".tagName")
          if (-not $tag) { throw "Could not resolve release tag from f-io/ffmpeg-bundles" }

          gh release download $tag `
            --repo f-io/ffmpeg-bundles `
            --pattern $assetName `
            --dir $env:RUNNER_TEMP

          if (-not (Test-Path $zip)) { throw "Downloaded asset not found: $zip" }

          $extract = Join-Path $env:RUNNER_TEMP "ffplay_extract"
          if (Test-Path $extract) { Remove-Item $extract -Recurse -Force }
          Expand-Archive -Path $zip -DestinationPath $extract -Force

          $ffplay = Get-ChildItem -Path $extract -Recurse -Filter "ffplay.exe" | Select-Object -First 1
          if (-not $ffplay) { throw "ffplay.exe not found in $assetName" }

          $binDir = Split-Path $ffplay.FullName -Parent

          Copy-Item "$binDir\ffplay.exe" "assets/bin/win/ffplay.exe" -Force
          Copy-Item "$binDir\*.dll" "assets/bin/win/" -Force -ErrorAction SilentlyContinue

          Write-Host "Bundled ffplay files:"
          Get-ChildItem "assets/bin/win" | Format-Table Name,Length

      - name: Build for Windows (native) [win-x64]
        if: matrix.platform == 'win-x64'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $ELECTRON_VERSION = node -p "require('./node_modules/electron/package.json').version"
          npx --yes node-gyp install --target="$ELECTRON_VERSION" --dist-url=https://artifacts.electronjs.org/headers/dist
          pnpm run typecheck
          pnpm run build:win

      # ----------------------------
      # Upload artifacts
      # ----------------------------
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: LIVI-${{ steps.pkg.outputs.version }}-${{ matrix.platform }}.${{ matrix.artifact_ext }}
          path: |
            dist/*${{ matrix.artifact_ext == 'dmg' && 'arm64.dmg' || (matrix.artifact_ext == 'AppImage' && (matrix.platform == 'arm64' && '-arm64.AppImage' || '-x86_64.AppImage')) || (matrix.artifact_ext == 'exe' && '-setup.exe') }}
          retention-days: 7

      - name: Push badges to version branch
        if: matrix.platform == 'x86_64' && (env.BUILD_BRANCH == 'main' || env.BUILD_BRANCH == 'dev')
        uses: ./.github/actions/badges
        with:
          branch: ${{ env.BUILD_BRANCH }}
          version: ${{ steps.pkg.outputs.version }}
          node: ${{ steps.pnpm.outputs.node }}
          pnpm: ${{ steps.pnpm.outputs.pnpm }}
          repo: ${{ github.repository }}
          token: ${{ secrets.GITHUB_TOKEN }}
