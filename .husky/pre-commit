#!/bin/sh
set -eu

echo "ğŸ” Running Prettier + Jest tests before commit..."

if ! npx lint-staged; then
  echo "âŒ Lint-staged failed, aborting commit."
  exit 1
fi

nul_list=$(
  git diff --cached --name-only -z --diff-filter=ACMRTUXB \
  | awk -v RS='\0' 'BEGIN{ORS=""} $0 ~ /\.(ts|tsx|js|jsx)$/ {printf "%s\0", $0}'
)

if [ -z "$nul_list" ]; then
  echo "â„¹ï¸  No testable files staged. Skipping Jest."
  exit 0
fi

echo "ğŸ§ª Running related Jest tests on:"
printf '%s' "$nul_list" | tr '\0' '\n' | sed 's/^/   â€¢ /'

printf '%s' "$nul_list" \
| xargs -0 npx jest --config jest.web.config.js \
    --findRelatedTests --runInBand --bail --verbose --passWithNoTests \
|| { echo "âŒ Tests failed, aborting commit."; exit 1; }

echo "âœ… All checks passed!"
